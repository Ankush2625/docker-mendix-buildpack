#!/usr/bin/env python
import json
import logging
import os
import subprocess
import sys

# DATABASE_ENDPOINT = sys.argv[1]

logging.basicConfig(
    level=logging.DEBUG,
    stream=sys.stdout,
    format='%(levelname)s: %(message)s',
)

def export_vcap_services():
    logging.debug("Executing build_vcap_services...")
    vcap_services_data = open("vcap_services.json").read()
    logging.info("Set environment variable VCAP_SERVICES: \n {0}".format(vcap_services_data))
    os.environ['VCAP_SERVICES'] = vcap_services_data

def call_builpack_compilation():
    logging.debug("Executing call_builpack_compilation...")
    subprocess.call(["/buildpack/bin/compile", "/build", "/cache"])

if __name__ == '__main__':

    #if os.getenv('DATABASE_ENDPOINT') is None:
    #    logging.error(
    #        'VCAP_SERVICES environment variable not found.'
    #    )
    #    sys.exit(0)

    export_vcap_services()
    call_builpack_compilation()
    sys.exit(0)
